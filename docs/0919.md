# FastAPI Dependency Injection (DI) ì™„ì „ ì •ë³µ (2025-09-19)

## ğŸ¯ DI (Dependency Injection)ë€?

**Dependency Injection (ì˜ì¡´ì„± ì£¼ì…)**ì€ ê°ì²´ê°€ í•„ìš”í•œ ì˜ì¡´ì„±ì„ **ì™¸ë¶€ì—ì„œ ì£¼ì…ë°›ëŠ”** ë””ìì¸ íŒ¨í„´ì…ë‹ˆë‹¤.

### ê¸°ë³¸ ê°œë… ë¹„êµ

```python
# âŒ DI ì—†ì´ (ì§ì ‘ ìƒì„±)
class UserService:
    def __init__(self):
        self.user_repo = UserRepository()  # ì§ì ‘ ìƒì„± - ê°•í•œ ê²°í•©

# âœ… DI ì ìš© (ì™¸ë¶€ ì£¼ì…)
class UserService:
    def __init__(self, user_repo: IUserRepository):  # ì™¸ë¶€ì—ì„œ ì£¼ì…
        self.user_repo = user_repo  # ì•½í•œ ê²°í•©
```

---

## ğŸ”§ Before vs After: Clean Architecture ìœ„ë°˜ í•´ê²°

### 1. **Interface Layer ë³€í™”**

**Before:**
```python
def create_user(user: CreateUserBody):
    user_service = UserService()  # ì§ì ‘ ìƒì„± âŒ
```

**After:**
```python
@inject
def create_user(
    user: CreateUserBody,
    user_service: UserService = Depends(Provide[Container.user_service]),  # DI âœ…
):
```

### 2. **Application Layer ë³€í™”**

**Before:**
```python
def __init__(self):
    self.user_repo: IUserRepository = UserRepository()  # Infrastructure ì§ì ‘ import âŒ
```

**After:**
```python
@inject
def __init__(self, user_repo: IUserRepository):  # ì¸í„°í˜ì´ìŠ¤ë§Œ ì˜ì¡´ âœ…
    self.user_repo = user_repo
```

### 3. **ì˜ì¡´ì„± ë°©í–¥ ê°œì„ **
```
Before: Application â†’ Infrastructure (ì§ì ‘ ì˜ì¡´)
After:  Application â†’ Domain â† Infrastructure (ì˜¬ë°”ë¥¸ ë°©í–¥)
```

---

## ğŸ“¦ dependency-injector ë¼ì´ë¸ŒëŸ¬ë¦¬

### 1. `@inject` ë°ì½”ë ˆì´í„°

```python
@inject
def __init__(self, user_repo: IUserRepository):
```

**ì—­í• **: "ì´ í•¨ìˆ˜ëŠ” ì˜ì¡´ì„± ì£¼ì…ì´ í•„ìš”í•´!"ë¼ê³  í‘œì‹œ
**ë™ì‘**: Containerì—ì„œ ìë™ìœ¼ë¡œ ì˜ì¡´ì„±ì„ ì°¾ì•„ì„œ ì£¼ì…

### 2. `Provide` í´ë˜ìŠ¤

```python
user_service: UserService = Depends(Provide[Container.user_service])
```

**ì—­í• **: Containerì—ì„œ íŠ¹ì • ì„œë¹„ìŠ¤ë¥¼ ì œê³µë°›ê² ë‹¤ê³  ì„ ì–¸
**ë¬¸ë²•**: `Provide[Container.ì„œë¹„ìŠ¤_ì´ë¦„]`

### 3. `Container` íŒ¨í„´

```python
class Container(containers.DeclarativeContainer):
    wiring_config = containers.WiringConfiguration(
        package=["user"]
    )

    user_repo = providers.Factory(UserRepository)
    user_service = providers.Factory(UserService, user_repo=user_repo)
```

**ì—­í• **: ëª¨ë“  ì˜ì¡´ì„±ì„ ì¤‘ì•™ì—ì„œ ê´€ë¦¬í•˜ëŠ” **ì„¤ì • íŒŒì¼**

---

## ğŸ—ï¸ Container ìƒì„¸ ë¶„ì„

### 1. `DeclarativeContainer`

```python
class Container(containers.DeclarativeContainer):
```

**ì—­í• **: ëª¨ë“  ì˜ì¡´ì„±ì„ ì„ ì–¸ì ìœ¼ë¡œ ì •ì˜í•˜ëŠ” ì»¨í…Œì´ë„ˆ
**íŠ¹ì§•**: ì„¤ì • íŒŒì¼ì²˜ëŸ¼ ëª…í™•í•˜ê³  ì½ê¸° ì‰¬ìš´ êµ¬ì¡°

### 2. `WiringConfiguration`

```python
wiring_config = containers.WiringConfiguration(
    package=["user"]
)
```

**ì—­í• **: ì–´ë–¤ íŒ¨í‚¤ì§€ì—ì„œ `@inject`ë¥¼ ì°¾ì„ì§€ ì„¤ì •
**ë™ì‘**: `user` íŒ¨í‚¤ì§€ ì „ì²´ë¥¼ ìŠ¤ìº”í•´ì„œ ì˜ì¡´ì„± ì£¼ì… ëŒ€ìƒ ì°¾ê¸°

### 3. `providers.Factory` vs `providers.Singleton`

```python
user_repo = providers.Factory(UserRepository)      # ë§¤ë²ˆ ìƒˆ ê°ì²´ ìƒì„±
user_service = providers.Singleton(UserService)     # í•œ ë²ˆë§Œ ìƒì„±í•˜ê³  ì¬ì‚¬ìš©
```

**Factory**: í˜¸ì¶œí•  ë•Œë§ˆë‹¤ ìƒˆ ê°ì²´ ìƒì„± (stateless ì„œë¹„ìŠ¤ì— ì í•©)
**Singleton**: í•œ ë²ˆë§Œ ìƒì„±í•˜ê³  ì¬ì‚¬ìš© (ìƒíƒœê°€ ìˆëŠ” ê°ì²´ì— ì í•©)

### 4. ì˜ì¡´ì„± ì²´ì¸

```python
user_service = providers.Factory(UserService, user_repo=user_repo)
```

`user_service` â†’ `user_repo` ì˜ì¡´ì„±ì„ ìë™ìœ¼ë¡œ í•´ê²°

---

## âš¡ FastAPI í†µí•©: `Depends`

### FastAPIì˜ ì˜ì¡´ì„± ì£¼ì… ì‹œìŠ¤í…œ

```python
def create_user(
    user: CreateUserBody,
    user_service: UserService = Depends(Provide[Container.user_service]),
):
```

**ë™ì‘ ê³¼ì •:**
1. FastAPIê°€ ìš”ì²­ ë°›ìŒ
2. `Depends()`ê°€ Containerì—ì„œ `user_service` ìš”ì²­
3. Containerê°€ `UserService`ì™€ `UserRepository` ìƒì„±
4. ìƒì„±ëœ ê°ì²´ë¥¼ í•¨ìˆ˜ì— ì£¼ì…

### HTTP Status Code ê°œì„ 

```python
@router.post("", status_code=201)  # 201 Created
```

RESTful API ì„¤ê³„ ì›ì¹™ì— ë”°ë¼ ë¦¬ì†ŒìŠ¤ ìƒì„± ì‹œ 201 ì‘ë‹µ

---

## ğŸ”„ ì „ì²´ DI íë¦„

```
1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
   â†“
2. Containerê°€ ì˜ì¡´ì„± ê´€ê³„ íŒŒì•…
   â†“
3. HTTP ìš”ì²­ ë“¤ì–´ì˜´
   â†“
4. FastAPIê°€ Depends() í™•ì¸
   â†“
5. Containerì—ì„œ ê°ì²´ ìƒì„± & ì£¼ì…
   â†“
6. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰
```

---

## ğŸ¯ DIì˜ í•µì‹¬ ê°€ì¹˜

### 1. **SOLID ì›ì¹™ ì¤€ìˆ˜**
- **D**ependency Inversion: ì¶”ìƒí™”ì— ì˜ì¡´
- ê³ ìˆ˜ì¤€ ëª¨ë“ˆì´ ì €ìˆ˜ì¤€ ëª¨ë“ˆì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ

### 2. **í…ŒìŠ¤íŠ¸ ìš©ì´ì„±**
```python
# ì‹¤ì œ DB ì—†ì´ë„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
container.user_repo.override(providers.Factory(MockUserRepository))

# ë˜ëŠ” FastAPI í…ŒìŠ¤íŠ¸ì—ì„œ
def test_create_user():
    mock_service = MockUserService()
    app.dependency_overrides[get_user_service] = lambda: mock_service
```

### 3. **ì„¤ì • ì¤‘ì•™í™”**
```python
# ëª¨ë“  ì˜ì¡´ì„±ì´ Containerì—ì„œ í•œëˆˆì— ë³´ì„
user_service = providers.Factory(UserService, user_repo=user_repo)
```

### 4. **ëŸ°íƒ€ì„ êµì²´**
```python
# í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ êµ¬í˜„ì²´ ì‚¬ìš© ê°€ëŠ¥
if ENV == "test":
    container.user_repo.override(providers.Factory(MockUserRepository))
elif ENV == "prod":
    container.user_repo.override(providers.Factory(PostgreSQLUserRepository))
```

### 5. **ìœ ì—°í•œ ì•„í‚¤í…ì²˜**
```python
# ìƒˆë¡œìš´ ì €ì¥ì†Œë¡œ êµì²´í•´ë„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ê·¸ëŒ€ë¡œ
container.user_repo = providers.Factory(RedisUserRepository)
```

---

## ğŸ† Clean Architecture ë‹¬ì„±ë„

**Before**: 60% (ë ˆì´ì–´ ë¶„ë¦¬ëŠ” ëì§€ë§Œ ì˜ì¡´ì„± ìœ„ë°˜)
**After**: 95% (ê±°ì˜ ì™„ë²½í•œ Clean Architecture!)

### ìµœì¢… ì•„í‚¤í…ì²˜ êµ¬ì¡°

```
HTTP Request
    â†“
ğŸŒ Interface Layer (user_controller.py)
    â†“ @inject + Depends(Provide[Container.user_service])
ğŸ¯ Application Layer (user_service.py)
    â†“ @inject + user_repo: IUserRepository
ğŸ’ Domain Layer (user.py, user_repo.py)
    â†“ Pure Business Objects
ğŸ”§ Infrastructure Layer (user_repo.py, db_models)
    â†“ DB ì €ì¥
ğŸ“Š Database
```

**í•µì‹¬**: ëª¨ë“  ì˜ì¡´ì„±ì´ Containerì—ì„œ ê´€ë¦¬ë˜ê³ , ëŸ°íƒ€ì„ì— ì£¼ì…ë¨

---

## ğŸ“š ì£¼ìš” ê°œë… ì •ë¦¬

### Port vs Adapter (ë‹¤ì‹œ ì •ë¦¬)
- **Port (IUserRepository)**: Domainì—ì„œ ì •ì˜í•œ "ê³„ì•½ì„œ"
- **Adapter (UserRepository)**: Infrastructureì—ì„œ ì‹¤ì œ "êµ¬í˜„ì²´"

### Interface ìš©ì–´ êµ¬ë¶„
- **IUserRepositoryì˜ Interface**: í”„ë¡œê·¸ë˜ë° ìš©ì–´ (ì¶”ìƒ í´ë˜ìŠ¤/ì¸í„°í˜ì´ìŠ¤)
- **Clean Architectureì˜ Interface Layer**: ì•„í‚¤í…ì²˜ ìš©ì–´ (HTTP API ê³„ì¸µ)

### IoC (Inversion of Control)
- **ì œì–´ì˜ ì—­ì „**: ê°ì²´ ìƒì„± ì œì–´ê¶Œì„ ì™¸ë¶€(Container)ì— ìœ„ì„
- **DIëŠ” IoCë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²• ì¤‘ í•˜ë‚˜**

---

## ğŸš€ ì‹¤ë¬´ ì ìš© íŒ

### 1. Container ì„¤ê³„ ì›ì¹™
```python
# ì¸í„°í˜ì´ìŠ¤ë³„ë¡œ ê·¸ë£¹í™”
class Container(containers.DeclarativeContainer):
    # Repository Layer
    user_repo = providers.Factory(UserRepository)
    product_repo = providers.Factory(ProductRepository)

    # Service Layer
    user_service = providers.Factory(UserService, user_repo=user_repo)
    product_service = providers.Factory(ProductService, product_repo=product_repo)
```

### 2. í™˜ê²½ë³„ ì„¤ì •
```python
# config/containers.py
class DevelopmentContainer(Container):
    user_repo = providers.Factory(MockUserRepository)

class ProductionContainer(Container):
    user_repo = providers.Factory(PostgreSQLUserRepository)
```

### 3. ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬
```python
# DB ì—°ê²°ì€ Singletonìœ¼ë¡œ
database = providers.Singleton(Database)

# ë¹„ì¦ˆë‹ˆìŠ¤ ì„œë¹„ìŠ¤ëŠ” Factoryë¡œ
user_service = providers.Factory(UserService)
```

**ì´ì œ ì§„ì •í•œ Enterpriseê¸‰ ì•„í‚¤í…ì²˜ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!** ğŸ¯

ì™¸ë¶€ ê¸°ìˆ ì´ ë°”ë€Œì–´ë„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ì™„ì „íˆ ë³´í˜¸ë˜ê³ , í…ŒìŠ¤íŠ¸ë„ ì‰½ê³ , ìœ ì§€ë³´ìˆ˜ì„±ì´ ê·¹ëŒ€í™”ëœ Clean Architecture + DI ì‹œìŠ¤í…œì…ë‹ˆë‹¤! âœ¨