# FastAPI Clean Architecture ë¶„ì„ (2025-09-17)

## Clean Architecture ê°œìš”

Clean ArchitectureëŠ” ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ **ë™ì‹¬ì› êµ¬ì¡°**ë¡œ ì„¤ê³„í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

### í•µì‹¬ ì›ì¹™
- **ì˜ì¡´ì„± ë°©í–¥**: ë°”ê¹¥ìª½ â†’ ì•ˆìª½ìœ¼ë¡œë§Œ ì˜ì¡´ (ì•ˆìª½ì€ ë°”ê¹¥ìª½ì„ ëª¨ë¦„)
- **ê´€ì‹¬ì‚¬ ë¶„ë¦¬**: ê° ë ˆì´ì–´ëŠ” ëª…í™•í•œ ë‹¨ì¼ ì±…ì„
- **ë…ë¦½ì„±**: ì™¸ë¶€ ê¸°ìˆ  ë³€ê²½ì´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ

### 4ê°œ ë ˆì´ì–´
1. **Domain** - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ì—”í‹°í‹°
2. **Application** - ìœ ìŠ¤ì¼€ì´ìŠ¤, ì„œë¹„ìŠ¤
3. **Infrastructure** - ë°ì´í„°ë² ì´ìŠ¤, ì™¸ë¶€ API
4. **Interface** - ì»¨íŠ¸ë¡¤ëŸ¬, API ì—”ë“œí¬ì¸íŠ¸

---

## 1. Domain Layer - ë¹„ì¦ˆë‹ˆìŠ¤ì˜ í•µì‹¬

### `user/domain/user.py` - ì—”í‹°í‹°

```python
@dataclass
class User:
    id: str
    name: str
    email: str
    password: str
    created_at: datetime
    updated_at: datetime
```

**ğŸ¯ ì„¤ê³„ ì² í•™:**
- **Pure Business Object**: FastAPI, SQLAlchemy ë“± ê¸°ìˆ ì  ì˜ì¡´ì„± 0
- **Immutable Design**: `@dataclass`ë¡œ êµ¬ì¡°ì²´ì²˜ëŸ¼ ë™ì‘
- **Domain Language**: ë¹„ì¦ˆë‹ˆìŠ¤ ìš©ì–´ ê·¸ëŒ€ë¡œ ì‚¬ìš©

**ğŸ” ì„¸ë¶€ ë¶„ì„:**
- `id: str` â†’ ULID ì‚¬ìš© ì˜ë„ (UUIDë³´ë‹¤ ì •ë ¬ ê°€ëŠ¥)
- `password: str` â†’ ì´ë¯¸ ì•”í˜¸í™”ëœ ìƒíƒœë¡œ ì €ì¥
- `created_at/updated_at` â†’ ê°ì‚¬(Audit) ëª©ì 

### `user/domain/repository/user_repo.py` - í¬íŠ¸(Port)

```python
class IUserRepository(metaclass=ABCMeta):
    @abstractmethod
    def save(self, user: User):
        raise NotImplementedError

    @abstractmethod
    def find_by_email(self, email: str) -> User:
        """
        ì´ë©”ì¼ë¡œ ìœ ì €ë¥¼ ê²€ìƒ‰í•œë‹¤.
        ê²€ìƒ‰í•œ ìœ ì €ê°€ ì—†ì„ ê²½ìš° 422 ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
        """
        raise NotImplementedError
```

**ğŸ¯ ì„¤ê³„ ì² í•™:**
- **Hexagonal Architectureì˜ Port**: ì™¸ë¶€ì™€ì˜ ê³„ì•½ì„œ
- **ì˜ì¡´ì„± ì—­ì „**: Domainì´ Infrastructureë¥¼ ëª¨ë¦„
- **í…ŒìŠ¤íŠ¸ ìš©ì´ì„±**: Mock êµ¬í˜„ì²´ë¡œ ì‰½ê²Œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

---

## 2. Application Layer - ìœ ìŠ¤ì¼€ì´ìŠ¤ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜

### `user/application/user_service.py`

```python
class UserService:
    def __init__(self):
        self.user_repo: IUserRepository = UserRepository()  # DI
        self.ulid = ULID()
        self.crypto = Crypto()

    def create_user(self, name: str, email: str, password: str):
        # 1. ì¤‘ë³µ ê²€ì‚¬
        try:
            _user = self.user_repo.find_by_email(email)
        except HTTPException as e:
            if e.status_code != 422:  # 422ê°€ ì•„ë‹Œ ì—ëŸ¬ëŠ” ì¬ë°œìƒ
                raise e

        if _user:
            raise HTTPException(status_code=422)  # ì¤‘ë³µ ìœ ì €

        # 2. ë„ë©”ì¸ ê°ì²´ ìƒì„±
        now = datetime.now()
        user: User = User(
            id=self.ulid.generate(),
            name=name,
            email=email,
            password=self.crypto.encrypt(password),
            created_at=now,
            updated_at=now,
        )

        # 3. ì €ì¥
        self.user_repo.save(user)
        return user
```

**ğŸ¯ ì„¤ê³„ ì² í•™:**
- **Use Case Pattern**: "íšŒì›ê°€ì…"ì´ë¼ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì‹œë‚˜ë¦¬ì˜¤ êµ¬í˜„
- **Service Layer**: ë„ë©”ì¸ ê°ì²´ë“¤ì„ ì¡°í•©í•˜ì—¬ ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
- **Transaction Script**: ì ˆì°¨ì  ìŠ¤íƒ€ì¼ë¡œ ëª…í™•í•œ íë¦„

**ğŸ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ íë¦„:**
1. **ì¤‘ë³µ ê²€ì‚¬**: 422 ì˜ˆì™¸ ì²˜ë¦¬ë¡œ "ìœ ì € ì—†ìŒ"ì„ ì •ìƒ í”Œë¡œìš°ë¡œ ì²˜ë¦¬
2. **ë„ë©”ì¸ ê·œì¹™**: ì´ë©”ì¼ ì¤‘ë³µ ë¶ˆí—ˆ
3. **ë³´ì•ˆ**: íŒ¨ìŠ¤ì›Œë“œ ì•”í˜¸í™”
4. **ID ìƒì„±**: ULIDë¡œ ê³ ìœ ì„± ë³´ì¥

**ì˜ˆì™¸ ì²˜ë¦¬ ì „ëµ:**
```python
if e.status_code != 422:
    raise e
```
- 422(ìœ ì € ì—†ìŒ)ëŠ” ì •ìƒ, ë‹¤ë¥¸ ì—ëŸ¬ëŠ” ì‹œìŠ¤í…œ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬

---

## 3. Infrastructure Layer - ê¸°ìˆ ì  êµ¬í˜„

### `user/infra/db_models/user.py` - ORM ëª¨ë¸

```python
class User(Base):
    __tablename__ = "User"

    id: Mapped[str] = mapped_column(String(36), primary_key=True)
    name: Mapped[str] = mapped_column(String(32), nullable=False)
    email: Mapped[str] = mapped_column(String(64), nullable=False, unique=True)
    password: Mapped[str] = mapped_column(String(64), nullable=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, nullable=False)
    updated_at: Mapped[datetime] = mapped_column(DateTime, nullable=False)
```

**ğŸ¯ ì„¤ê³„ ì² í•™:**
- **Persistence Model**: ìˆœìˆ˜ ë°ì´í„°ë² ì´ìŠ¤ ê´€ì ì˜ ëª¨ë¸
- **SQLAlchemy 2.0 Style**: ìµœì‹  íƒ€ì… íŒíŠ¸ ë°©ì‹ ì‚¬ìš©
- **Domainê³¼ ë¶„ë¦¬**: ê°™ì€ ì´ë¦„ì´ì§€ë§Œ ì™„ì „íˆ ë‹¤ë¥¸ ëª©ì 

**ğŸ” ë°ì´í„° ì œì•½ì‚¬í•­:**
- `email: unique=True` â†’ DB ë ˆë²¨ì—ì„œ ì¤‘ë³µ ë°©ì§€
- `String(36)` â†’ ULID ê¸¸ì´ì— ë§ì¶¤
- `String(64)` â†’ ì•”í˜¸í™”ëœ íŒ¨ìŠ¤ì›Œë“œ ê¸¸ì´ ê³ ë ¤

### `user/infra/repository/user_repo.py` - Adapter êµ¬í˜„

```python
class UserRepository(IUserRepository):
    def save(self, user: UserVO):
        new_user = User(  # Domain â†’ DB ëª¨ë¸ ë³€í™˜
            id=user.id,
            email=user.email,
            name=user.name,
            password=user.password,
            created_at=user.created_at,
            updated_at=user.updated_at,
        )

        with SessionLocal() as db:
            try:
                db.add(new_user)
                db.commit()
            finally:
                db.close()

    def find_by_email(self, email: str) -> UserVO:
        with SessionLocal() as db:
            user = db.query(User).filter(User.email == email).first()

        if not user:
            raise HTTPException(status_code=422)

        return UserVO(**row_to_dict(user))  # DB â†’ Domain ë³€í™˜
```

**ğŸ¯ ì„¤ê³„ ì² í•™:**
- **Hexagonal Architectureì˜ Adapter**: Portë¥¼ ì‹¤ì œ ê¸°ìˆ ë¡œ êµ¬í˜„
- **Object Mapping**: Domain â†” Persistence ë³€í™˜ ë‹´ë‹¹
- **Transaction Management**: DB ì„¸ì…˜ ê´€ë¦¬

**ğŸ” ëª¨ë¸ ë³€í™˜ íŒ¨í„´:**
```python
# Domain â†’ Infrastructure
new_user = User(id=user.id, ...)

# Infrastructure â†’ Domain
return UserVO(**row_to_dict(user))
```

---

## 4. Interface Layer - ì™¸ë¶€ ì„¸ê³„ì™€ì˜ ì ‘ì 

### `user/interface/controllers/user_controller.py`

```python
from fastapi import APIRouter
from pydantic import BaseModel
from user.application.user_service import UserService

router = APIRouter(prefix="/users")

class CreateUserBody(BaseModel):
    name: str
    email: str
    password: str

@router.post("")
def create_user(user: CreateUserBody):
    user_service = UserService()
    created_user = user_service.create_user(
        name=user.name,
        email=user.email,
        password=user.password
    )

    return created_user
```

**ğŸ¯ ì„¤ê³„ ì² í•™:**
- **API Gateway Pattern**: HTTP ìš”ì²­ì„ Application ë ˆì´ì–´ë¡œ ë¼ìš°íŒ…
- **DTO Pattern**: `CreateUserBody`ë¡œ ì…ë ¥ ë°ì´í„° ê²€ì¦
- **Presentation Layer**: ì™¸ë¶€ í”„ë¡œí† ì½œ(HTTP)ê³¼ ë‚´ë¶€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¶„ë¦¬

**ğŸ” ì»¨íŠ¸ë¡¤ëŸ¬ ì±…ì„:**
1. **ìš”ì²­ íŒŒì‹±**: HTTP â†’ Python ê°ì²´
2. **ì„œë¹„ìŠ¤ í˜¸ì¶œ**: Application ë ˆì´ì–´ ìœ„ì„
3. **ì‘ë‹µ ë³€í™˜**: Python ê°ì²´ â†’ HTTP JSON

**ì…ë ¥ ê²€ì¦:**
```python
class CreateUserBody(BaseModel):
    name: str
    email: str
    password: str
```
- **Pydantic**: FastAPIì™€ í†µí•©ëœ ìë™ ê²€ì¦
- **Type Safety**: ëŸ°íƒ€ì„ íƒ€ì… ì²´í¬
- **API ë¬¸ì„œ**: ìë™ OpenAPI ìŠ¤í‚¤ë§ˆ ìƒì„±

---

## ì „ì²´ ì•„í‚¤í…ì²˜ íë¦„

```
HTTP Request
    â†“
ğŸŒ Interface Layer (user_controller.py)
    â†“ CreateUserBody â†’ name, email, password
ğŸ¯ Application Layer (user_service.py)
    â†“ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§: ì¤‘ë³µ ê²€ì‚¬, ì•”í˜¸í™”, ID ìƒì„±
ğŸ’ Domain Layer (user.py, user_repo.py)
    â†“ Pure Business Objects
ğŸ”§ Infrastructure Layer (user_repo.py, db_models)
    â†“ DB ì €ì¥
ğŸ“Š Database
```

## í•µì‹¬ ì„¤ê³„ íŒ¨í„´ë“¤

### 1. ì˜ì¡´ì„± ì—­ì „ (DIP)
```
UserService â†’ IUserRepository â† UserRepository
```

### 2. ë ˆì´ì–´ ë¶„ë¦¬
- **Interface**: HTTP ê´€ì‹¬ì‚¬
- **Application**: ë¹„ì¦ˆë‹ˆìŠ¤ íë¦„
- **Domain**: í•µì‹¬ ê·œì¹™
- **Infrastructure**: ê¸°ìˆ  êµ¬í˜„

### 3. ëª¨ë¸ ë¶„ë¦¬
- `CreateUserBody` (ì…ë ¥ DTO)
- `User` (Domain Entity)
- `User` (DB Model)

ê°ê° ë‹¤ë¥¸ ê´€ì‹¬ì‚¬ë¥¼ ê°€ì§„ ì™„ë²½í•œ Clean Architecture êµ¬í˜„!

---

## í•™ìŠµ í¬ì¸íŠ¸

1. **í…ŒìŠ¤íŠ¸ ìš©ì´ì„±**: DB ì—†ì´ë„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
2. **ìœ ì—°ì„±**: DBë¥¼ MySQLì—ì„œ PostgreSQLë¡œ ë°”ê¿”ë„ í•µì‹¬ ë¡œì§ì€ ê·¸ëŒ€ë¡œ
3. **ë…ë¦½ì„±**: í”„ë ˆì„ì›Œí¬ê°€ ë°”ë€Œì–´ë„ ë„ë©”ì¸ ë¡œì§ì€ ë³´í˜¸
4. **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë³´í˜¸**: ì™¸ë¶€ ê¸°ìˆ ë¡œë¶€í„° í•µì‹¬ ë¡œì§ ë¶„ë¦¬

í•µì‹¬ì€ **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì™¸ë¶€ ê¸°ìˆ ë¡œë¶€í„° ë³´í˜¸**í•˜ëŠ” ê²ƒ! ğŸ¯